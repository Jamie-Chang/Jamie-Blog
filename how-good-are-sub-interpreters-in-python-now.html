<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>How good are sub-interpreters in Python now?</title>
                        <link rel="stylesheet" href="./theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
    <meta name="description" content="Introduction I wrote about free-threading recently in How free are threads in Python now?. Where I found some unexpected difficulties..." />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="./">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li class="active"><a href="./category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./how-good-are-sub-interpreters-in-python-now.html" rel="bookmark"
             title="Permalink to How good are sub-interpreters in Python now?">How good are sub-interpreters in Python now?</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-01-03T00:00:00+00:00">
                Published: Fri 03 January 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->        <h2>Introduction</h2>
<p>I wrote about free-threading recently in <a href="./how-free-are-threads-in-python-now.html">How free are threads in Python now?</a>. Where I found some unexpected difficulties parallelising my solution.</p>
<p>In the conclusion section I wrote:</p>
<blockquote>
<p>I'm starting to think that the approach <a href="https://peps.python.org/pep-0554/">sub-interpreters</a> is taking, with brand new concurrency primitives and shared memory data structures has a lot of merits. I like the idea of adding a new dimension of concurrency as opposed to modifying the current. Perhaps I'll try to implement my AOC solution using sub-interpreters.</p>
</blockquote>
<p>This week I tried sub-interpreters for the first time and was pleasantly surprised.</p>
<h2>Sub-interpreters</h2>
<p>The PEP to look at is <a href="https://peps.python.org/pep-0734">PEP 734 - Multiple Interpreters in the Stdlib</a>. But this is only possible because of the continued work in <a href="https://peps.python.org/pep-0684">PEP 684 - A Per-Interpreter GIL</a>.</p>
<p>In short, instead of achieving parallelism by removing the GIL, we create isolated memory spaces in the same process each paired with a GIL. The isolated memory spaces are the interpreter state, and memory access within the interpreter state is subject to the interpreter's GIL. Different interpreters are then able to run in parallel as they access independent memory spaces.</p>
<p>Certain objects can be shared via <a href="https://peps.python.org/pep-0734/#shareable-objects">sharable objects</a>. This is only possible because the interpreters all live in the same process. In multi-processing this is much harder to achieve.</p>
<p>PEP-734 is not officially accepted for 3.13, but its features are usable via Eric Snow's <a href="https://pypi.org/project/interpreters-pep-734">interpreters package</a>.</p>
<h2>AOC Implementation</h2>
<p>Full implementation can be found <a href="https://github.com/Jamie-Chang/advent2024-python/tree/main/subinterpreters">here</a>. I'll focus on the parts that specifically use the specification in the PEP.</p>
<p>Features like <a href="https://peps.python.org/pep-0554/#channels">channels</a> that are outside of the most recent specification though available are not used.</p>
<h3>Types</h3>
<p>First I looked at all the types that can be shared between interpreters and it's not so hard to define them as an annotation:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create a type so that we can type check what we pass into the shared state.</span>
<span class="nb">type</span> <span class="n">Shareable</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Shareable</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">Queue</span> <span class="o">|</span> <span class="nb">memoryview</span>
<span class="p">)</span>
</code></pre></div>

<p>Most shareable types are immutable with the exception of <code>Queue</code> and <code>memoryview</code>. They are the primary ways of passing data in and out of interpreters. <code>Queue.get</code> can also act as a mechanism to synchronise between interpreters.</p>
<h3>Interpreter</h3>
<p>Interpreters can also be initialised with some global shareable state. For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">interp</span><span class="o">.</span><span class="n">prepare_main</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="n">Queue</span><span class="p">(),</span> <span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>

<p>This is how we pass the <code>Queue</code> or <code>memoryview</code> objects into the interpreters in the first place.</p>
<p>Running code in interpreters requires using <code>Interpreter.exec</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">interp</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="n">interp</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;print(</span><span class="se">\&quot;</span><span class="s2">hello world</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This is analogous to <a href="https://docs.python.org/3/library/functions.html#exec"><code>exec</code></a> but in the specified interpreter. </p>
<p>There are also other ways to execute code I chose not to use like <a href="https://docs.python.org/3.14/library/concurrent.futures.html#concurrent.futures.InterpreterPoolExecutor">InterpreterPoolExecutor</a> which don't take advantage of shared objects, or <code>Interpreter.call</code> which places limitations on the function called.</p>
<p>Note: <code>Interpreter.exec</code> executes code in the foreground, so we would also need to wrap it in a thread.</p>
<h3>Calling a function</h3>
<p>Many of the examples in the PEO use an import inside the interpreter:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">interp</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;if True:</span>
<span class="s2">        from mymodule import edit_data</span>
<span class="s2">        while True:</span>
<span class="s2">            token = control.get()</span>
<span class="s2">            edit_data(data)</span>
<span class="s2">            control.put(token)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This is because functions are objects that are not shareable. So it's often just easier to have the interpreter recreate the function by importing. </p>
<h3>My wrapper</h3>
<p>Putting this all together, I wrote a wrapper to:</p>
<ul>
<li>create interpreters inside thread</li>
<li>import a function inside the interpreters to execute on input from the task queue</li>
<li>collect the results and close the interpreters</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Executor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">bind</span><span class="p">:</span> <span class="n">Shareable</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">entrypoint</span><span class="si">}</span><span class="s2"> as entrypoint</span>
<span class="s2">            from interpreters_backport import interpreters</span>

<span class="s2">            tasks = interpreters.Queue(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">            results = interpreters.Queue(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">            while True:</span>
<span class="s2">                req = tasks.get()</span>
<span class="s2">                if req is None:</span>
<span class="s2">                    # Stop!</span>
<span class="s2">                    break</span>
<span class="s2">                try:</span>
<span class="s2">                    res = entrypoint(*req, </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">bind</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                except Exception as e:</span>
<span class="s2">                    results.put((False, repr(e)))</span>
<span class="s2">                else:</span>
<span class="s2">                    results.put((True, res))</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">workers</span>

    <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
            <span class="n">interp</span><span class="o">.</span><span class="n">prepare_main</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">)</span>
        <span class="n">interp</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="n">interp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Iterator</span><span class="p">[</span><span class="n">Shareable</span><span class="p">]]:</span>
        <span class="k">def</span> <span class="nf">_iter</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
                <span class="n">success</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                    <span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span> <span class="n">Shareable</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InterpreterError</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">res</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">_iter</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">_iter</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Signal for interpreters to finish</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">its</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Shareable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Shareable</span><span class="p">]:</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">its</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="k">as</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">results</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div>

<p>This is derived from a lot of the examples in the PEP. However, there are a few quirks.</p>
<p>There's a <a href="https://github.com/ericsnowcurrently/interpreters/issues/20">bug</a> preventing me from passing queues inside the interpreters directly, so I used a workaround by passing <code>Queue.id</code> inside the interpreter.</p>
<p>In <code>_get_results</code> we signal termination using <code>self.tasks.put(None)</code>. This is done after collecting the results to prevent the interpreter from terminating before we collect objects returned from it.</p>
<p>The following example demonstrates what happens when the interpreters close too soon:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">interpreters_backport</span> <span class="kn">import</span> <span class="n">interpreters</span>

<span class="n">interp</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">interpreters</span><span class="o">.</span><span class="n">create_queue</span><span class="p">()</span>
<span class="n">interp</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
    <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        from interpreters_backport import interpreters</span>
<span class="s2">        queue = interpreters.Queue(</span><span class="si">{</span><span class="n">queue</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        queue.put((1, 2, 3))</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">interp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</code></pre></div>

<p>You receive the output <code>interpreters_backport.interpreters.queues.UNBOUND</code>., where <code>(1, 2, 3)</code> is expected.</p>
<h3>Running the executor</h3>
<p>Modifying my implementation we can run the executor:</p>
<div class="highlight"><pre><span></span><code><span class="n">candidates</span> <span class="o">=</span> <span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">if</span> <span class="n">node</span> <span class="o">!=</span> <span class="n">start</span><span class="p">)</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">(</span><span class="s2">&quot;implementations.d6&quot;</span><span class="p">,</span> <span class="s2">&quot;solve&quot;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
<span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workers</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;part2&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
</code></pre></div>

<p>where the solve function is located in a module <code>implementations.d6</code>. </p>
<p>Since <code>grid</code> is a constant, it's injected into each interpreter at the start too.</p>
<h3>The Results</h3>
<p>Results running using 1 to 15 workers. As a reminder we have 11 threads available on my machine.</p>
<div class="highlight"><pre><span></span><code>➜<span class="w">  </span>subinterpreters<span class="w"> </span>git:<span class="o">(</span>main<span class="o">)</span><span class="w"> </span>✗<span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>d6.py
Reading<span class="w"> </span>inline<span class="w"> </span>script<span class="w"> </span>metadata<span class="w"> </span>from<span class="w"> </span><span class="sb">`</span>d6.py<span class="sb">`</span>
part1<span class="w"> </span><span class="m">4883</span>
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span>.575728<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">1</span>.858705<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">1</span>.284574<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">0</span>.977416<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">0</span>.8245<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">0</span>.739645<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">0</span>.692572<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">0</span>.68285<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">0</span>.623754<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">0</span>.625284<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">0</span>.600622<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">0</span>.627131<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">0</span>.578773<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">0</span>.586851<span class="w"> </span>s<span class="w"> </span>elapsed
part2<span class="w"> </span><span class="m">1655</span><span class="p">;</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">0</span>.600652<span class="w"> </span>s<span class="w"> </span>elapsed
</code></pre></div>

<p>This surprised me a lot. After my efforts with free-threading, I was definitely expecting a lot more tweaks before getting anywhere. </p>
<p>Compared to my results of free threading:</p>
<p><img alt="interpreters vs threads" src="./images/AoC-day-6.png"></p>
<p>The speedup is much more predictable, where free-threading performance bottlenecks very quickly.</p>
<h2>My Overall Experience</h2>
<p>There's a lot to unpack here, not just on sub-interpreters but also free-threading. </p>
<h3>Sub-interpreters are unfinished/unpolished</h3>
<p>It's no surprise here. PEP-734 is not yet accepted, so the bugs are understandable. </p>
<p>There's definitely a lack of examples and documentation, but hopefully it's something that the community can help with.</p>
<p>I also think that maybe there's a high level abstraction missing here. The API is inspired by Golang and <a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes">CSP</a> in general. It's probably not what Pythonistas are most familiar with. Using <code>exec</code> also feels a bit strange. Hopefully the wider community can start creating abstractions that make it more usable.</p>
<h3>Free-threading is deceptively hard</h3>
<p>In my last post I wrote:</p>
<blockquote>
<p>However I'm a bit worried about existing multi-threaded code. Before free-threaded python, threads were used for IO bound operations when the GIL was released. It's going to be a big challenge if one day the GIL is disabled and the performance may become many times slower. </p>
</blockquote>
<p>This worries me the most, people are used to threads and that's supposed to be a positive, but in reality they are just used to the GIL.</p>
<p>Sub-interpreters are a new feature so it has an advantage here.</p>
<h3>Memory management is key</h3>
<p>Despite the awkwardness working with interpreters, when it finally ran it was achieved the goal of speeding up execution. By exposing mechanisms to explicitly manage memory the execution becomes a lot more predictable.</p>
<p>When it comes to free-threading, this is definitely missed. My hope is that over the next few releases we'll see frameworks work on memory management making free threading more viable.</p>
<h2>Finally</h2>
<p>I wasn't originally planning on using sub-interpreters in the first place, but I'm now fully behind the idea.</p>
<p>I hope it gathers a lot more interest this year and we'll see more interesting use cases and examples. </p>
<p>If this post piqued your interest then there's a lot more resources out there:</p>
<ul>
<li>Anthony Shaw's <a href="https://tonybaloney.github.io/posts/sub-interpreter-web-workers.html">post</a></li>
<li>Yury Selivanov's <a href="https://www.youtube.com/watch?v=fwRMdncVOnA">talk</a> which also mentions a new framework called <a href="https://github.com/edgedb/memhive">memhive</a></li>
</ul>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/jamie-chang.bsky.social/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>