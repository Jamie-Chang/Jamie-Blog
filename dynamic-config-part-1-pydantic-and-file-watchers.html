<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Dynamic config part 1: Pydantic and file watchers</title>
                        <link rel="stylesheet" href="./theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
    <meta name="description" content="Feature flags or dynamic configuration is something that I find very useful, however I've never had the chance to use them. This is for a lack of..." />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="./">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li class="active"><a href="./category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./dynamic-config-part-1-pydantic-and-file-watchers.html" rel="bookmark"
             title="Permalink to Dynamic config part 1: Pydantic and file watchers">Dynamic config part 1: Pydantic and file watchers</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-08-26T00:00:00+01:00">
                Published: Tue 26 August 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->        <p>Feature flags or dynamic configuration is something that I find very useful, however I've never had the chance to use them. This is for a lack of options <a href="https://launchdarkly.com/">launchdarkly</a>, <a href="https://www.flagsmith.com/">flagsmith</a> and <a href="https://www.getunleash.io/">unleash</a> to name a few. </p>
<p>SaaS options can be amazing with a full array of features, but I would love a simple solution to start with that can be set up in your own cluster.</p>
<p>I don't have a full solution in my head, instead I'm going to try and explore the space and work towards a solution over the next few posts.</p>
<h2>pydantic-settings</h2>
<p><a href="https://docs.pydantic.dev/latest/concepts/pydantic_settings/">pydantic-settings</a> would probably be the go to solution in Python for config management. Example configuration will look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">setting1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">setting2</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;toml_file&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;config.toml&quot;</span><span class="p">)}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">settings_customise_sources</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">settings_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseSettings</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">PydanticBaseSettingsSource</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">TomlConfigSettingsSource</span><span class="p">(</span><span class="n">settings_cls</span><span class="p">),)</span>


<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>

<p>We have a pydantic model with the fields <code>"setting1"</code> and <code>"setting2"</code>. There's a <code>model_config</code> that contains metadata which acts as the "settings of settings". The <code>settings_customise_sources</code> method defines the sources used to populate the and in what order. </p>
<p>I do have my misgivings how this works, mainly around the way the sources and tied to the object model. Something more functional would be clearer:</p>
<div class="highlight"><pre><span></span><code><span class="n">settings</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span>
    <span class="n">Settings</span><span class="p">,</span>
    <span class="n">toml_loader</span><span class="p">(</span><span class="s2">&quot;config.toml&quot;</span><span class="p">),</span>
    <span class="n">env_loader</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">),</span>
    <span class="o">...</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<p>But that's a topic for another day. </p>
<h2>Config from file</h2>
<p>Environment variables are undoubtedly the easiest way to configure an application. However there is no good method to update the envvar during a process' execution and have process reload it. </p>
<p>Another approach is to load configuration from network resources such as another service or databases. This is likely how existing SaaS solutions work. This is a viable choice that offers a ton of flexibility, the potential operational overhead is worrying, for example, what happens if we fail to load the config from the remote? We likely need to handle many different failure nodes in our application.</p>
<p>That's why I've chosen to configure the app a file as in the above example. Which is simple and more reliable than the network method. The file content can easily be changed by another process or manually. Likewise it can easily be viewed for debugging purposes.</p>
<p>Note that I've chosen to use toml in the above example, but pydantic-settings includes loaders for almost all <a href="https://docs.pydantic.dev/latest/concepts/pydantic_settings/#other-settings-source">formats</a>. My personal preference is toml for small amount of config and yaml for potentially large config files. </p>
<h2>Reloading the file dynamically</h2>
<p>That leaves us with the biggest question, how will we reload the file dynamically? </p>
<p>Luckily this is a question that already has well established answers: file watchers. File watchers are often used for local development to allow for dynamic reloading of servers. <a href="https://man7.org/linux/man-pages/man7/inotify.7.html">inotify</a> is one such exapmle on linux where a lot of server code is being run.</p>
<p>There are already many packages that make use of inotify, I've chosen <a href="https://watchfiles.helpmanual.io/">watchfiles</a> for its broad compatibility across multiple platforms and generally great performance.</p>
<p>The api is incredibly straightforward:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">awatch</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">):</span>
    <span class="o">...</span>  <span class="c1"># handle the file change</span>
</code></pre></div>

<p>We enter a new iteration every time there's file change, during this iteration we can reload the settings. There are sync apis available as well but I'll stick to async for now. </p>
<h2>Putting things together</h2>
<p>I've added everything together in a FastAPI service. The service has a single endpoint to fetch the current settings values. Django and flask services can also use something similar to this, which I may cover in the near future.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># /// script</span>
<span class="c1"># requires-python = &quot;&gt;=3.13&quot;</span>
<span class="c1"># dependencies = [</span>
<span class="c1">#     &quot;fastapi&quot;,</span>
<span class="c1">#     &quot;pydantic-settings&quot;,</span>
<span class="c1">#     &quot;uvicorn&quot;,</span>
<span class="c1">#     &quot;watchfiles&quot;,</span>
<span class="c1"># ]</span>
<span class="c1"># ///</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Self</span>

<span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic_settings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseSettings</span><span class="p">,</span>
    <span class="n">PydanticBaseSettingsSource</span><span class="p">,</span>
    <span class="n">TomlConfigSettingsSource</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">watchfiles</span> <span class="kn">import</span> <span class="n">awatch</span>


<span class="n">CONFIG_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;config.toml&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">setting1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">setting2</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;toml_file&quot;</span><span class="p">:</span> <span class="n">CONFIG_PATH</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">settings_customise_sources</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">settings_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseSettings</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">PydanticBaseSettingsSource</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">TomlConfigSettingsSource</span><span class="p">(</span><span class="n">settings_cls</span><span class="p">),)</span>


<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">auto_reload_settings</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">awatch</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">):</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>


<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">lifespan</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">auto_reload_settings</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>



<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/settings&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Settings</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">settings</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre></div>

<h3>A few notes</h3>
<h4>Reloading and loading the settings</h4>
<p>The documentation for inplace reloading can be found <a href="https://docs.pydantic.dev/latest/concepts/pydantic_settings/#in-place-reloading">here</a>. The direct invocation of <code>__init__</code> is a little odd so I've decided to encapsulate it as <code>reload</code> but otherwise this is just following the official documentation.</p>
<h4>Running a background asyncio task</h4>
<p><a href="https://fastapi.tiangolo.com/advanced/events/#use-case">lifespan</a> is the best way to add startup and teardown logic to a fastapi app. </p>
<p><a href="https://docs.python.org/3/library/asyncio-task.html#task-groups">asyncio.TaskGroup</a> is used here to handle the task future and avoid not await warnings. </p>
<h2>Next steps</h2>
<p>I think what I've put together here is a very simple solution, but simple solutions can work more reliably. </p>
<p>This is of course only the first step in hopefully a series of posts.In the near future I'll explore:</p>
<ul>
<li>Connecting the code with the infrastructure (e.g. kubernetes) we're running the code on. </li>
<li>Solving the observability challenge that comes with dynamically changing configuration.</li>
</ul>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/jamie-chang.bsky.social/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>