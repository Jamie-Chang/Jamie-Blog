<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Jamie's Blog - Jamie Chang</title>
                        <link rel="stylesheet" href="../theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li><a href="../category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="../writing-a-sqs-task-framework-from-scratch.html">Writing a SQS task framework from scratch</a></h1>
<footer class="post-info">
        <abbr class="published" title="2026-01-18T00:00:00+00:00">
                Published: Sun 18 January 2026
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/asyncio.html">Asyncio</a> <a href="../tag/sqs.html">SQS</a> </p>        
</footer><!-- /.post-info --><p>Recently I've been working on framework to run LLM tasks using AWS's excellent <a href="https://aws.amazon.com/sqs/">SQS</a>. And I made the decision to write my own task framework/library as opposed to using a pre-exiting framework. I thought this would be a great opportunity to discuss the considerations and levels of abstractions involved when coding a framework.</p>
<h3>Why SQS?</h3>
<p>Having come from using traditional message queues like RabbitMQ, I can't help but compare SQS with RabbitMQ. The thing is, whilst they can be interchangeable. I think they are actually built with different use cases in mind.</p>
<p>RabbitMQ is for processing a large volume of messages, the messages are strictly processed in FIFO order. SQS has more flexibility around when a message is processed and how long each task takes. So RabbitMQ is good for handling events, but SQS is better for tasks like LLM calls.</p>
<p>Additionally, SQS uses http to communicate between the server and the client which is easier to monitor and is easier to setup if you already have an AWS cluster.</p>
<h3>Why not use ...?</h3>
<p>Okay so, the first question I will answer you is why not a pre-existing framework? </p>
<p>When we talk about task framework in Python, there is a general consensus. The most popular choice is <a href="https://docs.celeryq.dev/en/stable/getting-started/introduction.html">Celery</a>, a framework that can handle pretty much any handle workload in any broker (be it SQS or otherwise). If you need a UI and compose tasks in a DAG (Directed Acyclic Graph) then you should use <a href="https://airflow.apache.org/">Airflow</a>. If you like new technology and talking about orchestration then use something <a href="https://temporal.io/">temporal</a>. The list really goes on and on. </p>
<p>I haven't used a lot of managed task solutions like temporal which admittedly is something I'd love to try out.</p>
<p>As for why I don't use something like celery. Celery is a framework that tries to work with everything including all brokers. That is only true to an extent as it was originally designed to work with RabbitMQ. Generally the support is also pretty good for Redis but not so good otherwise. A lot of broker specific features are either not supported or not documented.</p>
<p>Another issue is a lack of asyncio support. For my use case asyncio is great, no need for multiple threads or processes. Celery again tries very hard to be general, it supports the concurrency paradigm most likely to support a user's code without a lot of input from the user. But in my case, I already have an opinion of how I want my code to run, and it just doesn't make sense to use it.</p>
<p>Finally, my general complaint of celery is that it requires a lot of configuration for a production use case. Which can cause quite a bit of a headache. </p>
<h2>Creating my abstractions</h2>
<p>In my experience writing a good framework is all about how good the abstractions are. Abstractions can come with a cost. Whilst Celery create abstractions that allow task compositions and provides support for many brokers, but it trades broker specific features and increases in configuration complexity.</p>
<p>Therefore a good abstraction is about making useful trade-offs. </p>
<h3>Writing the code</h3>
<p>Before we start with abstractions, it's a good idea to first write some code to see what the it currently looks like with no abstraction.</p>
<p>Here I ask a LLM to provide an example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">aiobotocore.session</span> <span class="kn">import</span> <span class="n">get_session</span>

<span class="c1"># Replace with your actual Queue URL</span>
<span class="n">QUEUE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.us-east-1.amazonaws.com/123456789012/my-queue&quot;</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">consume_messages</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>

    <span class="c1"># create_client is an async context manager that handles connection cleanup</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listening for messages on </span><span class="si">{</span><span class="n">QUEUE_URL</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># receive_message calls the SQS API</span>
                <span class="c1"># WaitTimeSeconds=20 enables Long Polling (waits for messages to arrive)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive_message</span><span class="p">(</span>
                    <span class="n">QueueUrl</span><span class="o">=</span><span class="n">QUEUE_URL</span><span class="p">,</span>
                    <span class="n">MaxNumberOfMessages</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">WaitTimeSeconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">VisibilityTimeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Check if &#39;Messages&#39; key exists in response</span>
                <span class="k">if</span> <span class="s1">&#39;Messages&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Messages&#39;</span><span class="p">]:</span>
                        <span class="c1"># 1. Process the message</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received body: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># 2. Delete the message so it isn&#39;t processed again</span>
                        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_message</span><span class="p">(</span>
                            <span class="n">QueueUrl</span><span class="o">=</span><span class="n">QUEUE_URL</span><span class="p">,</span>
                            <span class="n">ReceiptHandle</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ReceiptHandle&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message deleted.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No messages received in this poll.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error encountered: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Backoff on error</span>
</code></pre></div>

<h3>Identifying Trade-offs</h3>
<p>Next we look at things we want to change and thus the trade-offs.</p>
<p>Let's start with deleting the message, the purpose of deleting the message is to signal that the message is complete and shouldn't be processed again. I personally don't like the naming of this, in the context of message queues this is usually called <code>ack</code>. </p>
<p>Something like:</p>
<div class="highlight"><pre><span></span><code><span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>Next, let's look at some of the attributes we can abstract:</p>
<ul>
<li><code>VisibilityTimeout</code>: is the amount of time the message can be processed for before going back on the queue, it is also how we can delay the message for when adding a message to the queue. We can make this clearer by calling it keep-alive and delay respectively.</li>
<li><code>MaxNumberOfMessages</code>: is a useful feature of SQS to fetch a batch of messages at once to increase throughput and reduce the cloud bill. But it may not be a good fit for my use case handling LLM requests as they don't work well in batches</li>
<li><code>WaitTimeSeconds</code> enables long polling which reduces the number of requests and hence the cloud bill. This is a good idea to keep on. And there's no real need for us to turn it off. </li>
</ul>
<h3>Creating the client</h3>
<p>Now that the trade offs are identified, we will start to create the client code, and this is what I've come up with:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QueueClient</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">SQSClient</span>
    <span class="n">queue</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_alive</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">MessageTypeDef</span><span class="p">]:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">receive_message</span><span class="p">(</span>
                <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                <span class="n">MaxNumberOfMessages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">WaitTimeSeconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span><span class="p">,</span>
                <span class="n">VisibilityTimeout</span><span class="o">=</span><span class="n">keep_alive</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">match</span> <span class="n">messages</span><span class="p">:</span>
                <span class="k">case</span> <span class="p">{</span><span class="s2">&quot;Messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]}:</span>
                    <span class="k">yield</span> <span class="n">message</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete_message</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">ReceiptHandle</span><span class="o">=</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;ReceiptHandle&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div>

<p>In order to pass the messages to the user, I've represented the stream of messages as an AsyncIterator. Iterators are truly one of Python's best features, and here it fits particularly well as are trying to expose the messages to the user without making may assumptions about how to user wants to consume it.</p>
<p>Consuming messages then is as simple as running an async for loop:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">handle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<h3>Error Handling</h3>
<p>A good task framework should provide utilities to handle errors well, in our scenario we simply terminate if we encounter an error. This could be enough provided that we automatically restart our process, but generally this is not the expectation.</p>
<p>The standard terminology for this is <code>nack</code> the opposite of <code>ack</code>. In SQS terms this is simply <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sqs/client/change_message_visibility.html#SQS.Client.change_message_visibility"><code>change_message_visibility</code></a> or <code>delete_message</code> depending whether we want to retry.</p>
<p>So inside <code>QueueClient</code> goes:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QueueClient</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">nack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">,</span> <span class="n">retry_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">retry_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">change_message_visibility</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">ReceiptHandle</span><span class="o">=</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;ReceiptHandle&quot;</span><span class="p">],</span>
            <span class="n">VisibilityTimeout</span><span class="o">=</span><span class="n">retry_timeout</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>

<p>Consuming messages with error handling is:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">handle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">nack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>We can clearly abstract this more, e.g. retrying on some fix interval or based on the number of failures prior. But this is a decision that ultimately is up to the user, and we shouldn't try to abstract it in the most basic client.</p>
<h3>Extending keep alive</h3>
<p>One thing writing our own abstraction enables us to do is to extend the keep alive. This is one thing celery is not particularly good for. I believe it simply sets it to a very big value, which could cause problems if a message needs to be retied.</p>
<p>Extending the keep-alive is the same operation as retrying: <code>change_message_visibility</code> in one case we set the timeout so that we can retry after a period of time, in the other case we extend the timeout so that we won't retry too soon. </p>
<p>In the <code>QueueClient</code> goes:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QueueClient</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">change_message_visibility</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">ReceiptHandle</span><span class="o">=</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;ReceiptHandle&quot;</span><span class="p">],</span>
            <span class="n">VisibilityTimeout</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>

<h2>Abstracting consumption</h2>
<p>As it is right now, our <code>QueueClient</code> can be tested and used. We know that it will function quite well because we've been careful to make abstraction decisions that improve usability but minimise the cost.</p>
<p>You may already see the next piece of complexity to tackle, as we have made our <code>QueueClient</code> simple, the consumer loop is more complex than it needs to be, requiring the user to understand how to manage the lifecycle of a message. </p>
<p>We've left this out because there are many different ways the user may want to manage the message's lifecycle, so enforcing one way may restrict the user's options. </p>
<p>However, we can provide some abstraction with helpful implementation without forcing the user to go down one path or the other. </p>
<p>To do this we can use a abstract base class or a <a href="https://typing.python.org/en/latest/spec/protocol.html">Protocol</a> to define what we want the <code>LifeCycle</code> to look like:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LifeCycle</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines the lifecycle of a single message.</span>

<span class="sd">    That is what happens </span>
<span class="sd">        - when a message is processed successfully</span>
<span class="sd">        - when a message errors</span>
<span class="sd">        - during the message processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncContextManager</span><span class="p">[</span><span class="n">MessageTypeDef</span><span class="p">]:</span>
        <span class="o">...</span>
</code></pre></div>

<p>We use a <code>AsyncContextManager</code> here because it gives us the most flexibility, wrapping the message handler.</p>
<p>So our basic version of message processing would look something like: </p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BasicLifeCycle</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">QueueClient</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">MessageTypeDef</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">message</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>We can improve on this with a retry option:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RetryLifeCycle</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">QueueClient</span>
    <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">MessageTypeDef</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">message</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nack</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>And adding more complexity for convenience, we can also provide a background task to keep the message alive. This allows us to process the message for a functionally infinite amount of time:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">HeartbeatLifeCycle</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">QueueClient</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">auto_keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_keep_alive</span><span class="p">():</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">keep_alive</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_keep_live</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">MessageTypeDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">MessageTypeDef</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">auto_keep_alive</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">message</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<h2>Finally putting everything together</h2>
<p>Let's compose what a single consumer would look like:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">QueueClient</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">life_cycle</span> <span class="o">=</span> <span class="n">HeartbeatLifeCycle</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">life_cycle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">handle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># That&#39;s it!</span>
</code></pre></div>

<p>Pretty easy right? And should the user want a different lifecycle or to not use it, they are free to do so without any restrictions enforced by the framework. </p>
<p>The philosophy here is to steer your user to the right direction but ultimately to trust them. Something I find most frameworks violating. </p>
<h3>Scaling it</h3>
<p>You might wonder if we can scale the task consumption. This is where our decision to use asyncio helps us. We needn't worry about abstractions to enable scaling ourselves as asyncio already comes with <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.TaskGroup">TaskGroup</a>.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">QueueClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">life_cycle</span> <span class="o">=</span> <span class="n">HeartbeatLifeCycle</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">life_cycle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">handle</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">QueueClient</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">workers</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">run</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
</code></pre></div>

<p>When there's a good standard library or well known abstraction, this lowers the cost on the user, as we are not creating anything novel. </p>
<h2>Closing Words</h2>
<p>Creating the perfect abstraction is no small task, a good place to start is something simple and humble. But even then it doesn't always work out in your first try. Sometimes we require many iterations.</p>
<p>I see some crazy abstraction that grow ad-hoc over a lengthy amount of time, gaining more and more features but not taking care of the abstraction. This is a common thing to happen, so it's okay to recognise an abstraction is not working and start over. Because only then can we work towards something better.</p>
<p>If you're interested in using this library/framework, it's published to pypi as <a href="https://pypi.org/project/simple-async-sqs/">simple-async-sqs</a>. </p>                    </article>
                </aside><!-- /#featured -->
                    <section id="content" class="body">
                        <h1>Other articles</h1>
                        <hr />
                        <ol id="posts-list" class="hfeed">

                <li><article class="hentry">
                    <header>
                        <h1><a href="../asyncio-is-neither-fast-nor-slow.html" rel="bookmark"
                               title="Permalink to Asyncio is neither fast nor slow">Asyncio is neither fast nor slow</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2026-01-12T00:00:00+00:00">
                Published: Mon 12 January 2026
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p><strong><em>Don't listen to random benchmarks..</em></strong></p>
<p>I recently came across an <a href="https://hackeryarn.com/post/async-python-benchmarks/">article</a> benchmarking Python performances in web frameworks, comparing asyncio and sync performance. </p>
<p>The author sets out to measure performance of <a href="https://fastapi.tiangolo.com/">FastAPI</a>/<a href="https://www.djangoproject.com/">Django</a> web servers running with postgresql comparing async and non-async workloads. The methodology is pretty reasonable, the following is â€¦</p>
                        <a class="readmore" href="../asyncio-is-neither-fast-nor-slow.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../i-was-wrong-about-subinterpreters.html" rel="bookmark"
                               title="Permalink to I was wrong about Subinterpreters">I was wrong about Subinterpreters</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2026-01-01T00:00:00+00:00">
                Published: Thu 01 January 2026
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">Ï€thon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/subinterpreters.html">Subinterpreters</a> </p>        
</footer><!-- /.post-info -->                        <p><strong><em>... but that's actually a good thing</em></strong></p>
<p>I've already written a ton about subinterpreters since a year ago:  </p>
<ul>
<li><a href="../how-good-are-sub-interpreters-in-python-now.html">How good are sub-interpreters in Python now?</a></li>
<li><a href="../python-314-state-of-free-threading.html">Python 3.14: State of free threading</a></li>
<li><a href="../subinterpreters-and-asyncio.html">Subinterpreters and Asyncio</a></li>
</ul>
<p>Recently I had some time to dig a bit deeper into subinterpreters and check my understanding â€¦</p>
                        <a class="readmore" href="../i-was-wrong-about-subinterpreters.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../trying-out-marimo-notebooks.html" rel="bookmark"
                               title="Permalink to Trying out marimo notebooks">Trying out marimo notebooks</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-12-03T00:00:00+00:00">
                Published: Wed 03 December 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>As we approach the holiday seasons, we get to "enjoy" another 12 days of <a href="https://adventofcode.com/">Advent of Code</a>. Every year I try to do something a little different, last year I had a lot of fun solving it in Ocaml, prior years I've tried the latest Python features. This year I've â€¦</p>
                        <a class="readmore" href="../trying-out-marimo-notebooks.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../fixing-lazy-imports-generating-static-types-dynamically.html" rel="bookmark"
                               title="Permalink to Fixing lazy imports: Generating Static Types Dynamically">Fixing lazy imports: Generating Static Types Dynamically</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-10-29T00:00:00+00:00">
                Published: Wed 29 October 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>So I've just released a package called <a href="https://pypi.org/project/lazy-helper/">lazy-helper</a>. This comes as lazy loading has been a hot topic once again due to the proposal <a href="https://peps.python.org/pep-0810/">PEP-810</a>.</p>
<p>Using my package we can define lazy loaded dependencies nicely:</p>
<p><img alt="Defining a lazy module" src="../images/lazypy.png"></p>
<p>Coincidentally Brian Okken has recently written a <a href="https://pythontest.com/polite-lazy-imports-python-packages/">blog post</a> covering the topic of lazy loading â€¦</p>
                        <a class="readmore" href="../fixing-lazy-imports-generating-static-types-dynamically.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../python-314-3-asyncio-changes.html" rel="bookmark"
                               title="Permalink to Python 3.14: 3 Asyncio Changes">Python 3.14: 3 Asyncio Changes</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-10-09T00:00:00+01:00">
                Published: Thu 09 October 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">Ï€thon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/asyncio.html">asyncio</a> </p>        
</footer><!-- /.post-info -->                        <p>Python 3.14 was officially released on October 7th. There are a lot of new features and I've covered some of them before in:</p>
<ul>
<li><a href="../python-314-3-smaller-features.html">Python 3.14: 3 smaller features</a></li>
<li><a href="../t-strings-the-good-and-the-ugly.html">t-strings: the good and the ugly</a></li>
<li><a href="../subinterpreters-and-asyncio.html">Subinterpreters and Asyncio</a></li>
</ul>
<p>What I haven't covered here are any of the asyncio changes â€¦</p>
                        <a class="readmore" href="../python-314-3-asyncio-changes.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../finally-trying-out-mojo.html" rel="bookmark"
                               title="Permalink to Finally trying out Mojo ðŸ”¥">Finally trying out Mojo ðŸ”¥</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-10-02T00:00:00+01:00">
                Published: Thu 02 October 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/mojo.html">Mojo</a> <a href="../tag/python.html">Python</a> <a href="../tag/advent-of-code.html">Advent of Code</a> </p>        
</footer><!-- /.post-info -->                        <p><a href="https://www.modular.com/mojo">Mojo</a> has been on my radar for a while. In fact, I heard about it on launch back in May 2023. It was touted as a super set of Python with 10000s of times the performance. It's main focus is on AI related workloads with strong built in support of â€¦</p>
                        <a class="readmore" href="../finally-trying-out-mojo.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../blog-1-year-in.html" rel="bookmark"
                               title="Permalink to Blog 1 year in">Blog 1 year in</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-09-24T00:00:00+01:00">
                Published: Wed 24 September 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>It's been just over a year since I started my blog. In fact, this is my 27th blog post. I thought it'd be a good time for me to share some insights on blogging.</p>
<h3>Motivation</h3>
<p>Recently I've been asked by some people on why I do this. I think for â€¦</p>
                        <a class="readmore" href="../blog-1-year-in.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../asyncio-backpressure-follow-up.html" rel="bookmark"
                               title="Permalink to Asyncio backpressure - follow up">Asyncio backpressure - follow up</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-09-14T00:00:00+01:00">
                Published: Sun 14 September 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>Previously when discussing <a href="../asyncio-backpressure-processing-lots-of-tasks-in-parallel.html">asyncio backpressure</a> I've made some claims that were not necessarily complete.</p>
<p>I said:</p>
<blockquote>
<p>It works well for 100s of urls but when we hit a big number like 10000s we have a problem.</p>
<p>The program seemingly hangs. This is because all the tasks are being created first â€¦</p></blockquote>
                        <a class="readmore" href="../asyncio-backpressure-follow-up.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../simplify-lambda-deployments-with-uv.html" rel="bookmark"
                               title="Permalink to Simplify lambda deployments with UV">Simplify lambda deployments with UV</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-09-01T00:00:00+01:00">
                Published: Mon 01 September 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>The python packaging landscape and developer experience has shifted dramatically in the past year or so with <a href="https://docs.astral.sh/uv/">uv</a>'s launch marked a pivotal moment. But behind the scenes many PEPs have worked to get us to this point. </p>
<p>One such PEP was <a href="https://peps.python.org/pep-0723/">PEP 723 â€“ Inline script metadata</a> which we discussed â€¦</p>
                        <a class="readmore" href="../simplify-lambda-deployments-with-uv.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>
                    </ol><!-- /#posts-list -->
  <nav>
    <ul>
      <li>Page 1 / 4</li>
        <li><a href="../author/jamie-chang2.html">&rang;</a></li>
        <li><a href="../author/jamie-chang4.html">&Rang;</a></li>
    </ul>
  </nav>
                    </section><!-- /#content -->
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/changs.co.uk/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>