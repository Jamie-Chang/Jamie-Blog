<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Jamie's Blog - Jamie Chang</title>
                        <link rel="stylesheet" href="../theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li><a href="../category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="../my-chinese-birthdays-time-keeping-is-hard.html">My Chinese birthdays, time keeping is hard!</a></h1>
<footer class="post-info">
        <abbr class="published" title="2025-06-25T00:00:00+01:00">
                Published: Wed 25 June 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info --><p>I grew up in both the UK and China. So I'd like to think I have a little understanding of both cultures. China uses both the western gregorian calendar and a version of lunar calendar called 农历. This means I have a Chinese lunar birthday as well as a normal one. </p>
<p>I did find a small library called <a href="https://github.com/lidaobing/python-lunardate">lunardate</a>:</p>
<p><link rel="stylesheet" href="https://pyscript.net/releases/2025.5.1/core.css"></p>
<!-- This script tag bootstraps PyScript -->
<script type="module" src="https://pyscript.net/releases/2025.5.1/core.js"></script>

<script type="py-editor" config='{"packages":["lunardate"]}'>
    from lunardate import LunarDate
    print("I was born on:", LunarDate.fromSolarDate(1995, 6, 28))
    print("My birthday this year is on:", LunarDate.fromSolarDate(2025, 6, 25))
</script>
<blockquote>
<p>Don't go all out on presents though, there's another one in exactly a month. </p>
</blockquote>
<p>If you run <code>LunarDate.fromSolarDate(2025, 7, 25)</code> you get <code>LunarDate(2025, 6, 1, 1)</code> which is the same date as <code>LunarDate.fromSolarDate(2025, 6, 25)</code> barring the last parameter <code>1</code> which indicates a leap month. Unlike leap days a leap month is a 'repeated' month. Happy birthday to me again! </p>
<blockquote>
<p>A leap month is caused by the difference between a solar year (365 ish days) and a lunar year 354 ish days. 3 months are added every 19 years. The maths checks out but the exact mechanism depends on some astrological observations.</p>
</blockquote>
<p>Fun fact, I wondered how the library knows when to add a leap month and the answer is quite simple! It has simply stored <a href="https://github.com/lidaobing/python-lunardate/blob/master/lunardate.py#L351-L405">all leap months</a> between 1900 and 2099.</p>
<h2>Back to the point</h2>
<blockquote>
<p>Apologies for the long winded story about my extra birthdays, now back to the regularly scheduled Python content</p>
</blockquote>
<p>I started thinking about how the chinese calendar is complicated syncing moon cycles to solar years. Trying to sync two cycles that don't directly relate to each other has necessitated the concept of leap months. </p>
<p>But then it occurred to me that's exactly what almost all calendars are doing! Leap days itself are necessitated by the ~8hr error trying to synchronise days with years. And gregorian months are really all over the place. Timekeeping in Python and other languages also has its quirks.</p>
<h3>Leap Seconds</h3>
<p>Leap months are actually a very similar concept to <a href="https://en.wikipedia.org/wiki/Leap_second">leap seconds</a>. Where occasionally due to various drifts in our time keeping we add an extra second. Like leap months, the date is determined by measurements, which is to say it's not deterministic when the leap second will be added. Though there is usually half a year of warning before the introduction. </p>
<p>In Python as in many programming languages and platforms, leap seconds are not explicitly tracked or represented due to its non-deterministic nature. Operating systems will either repeat the second deliberately slowdown the clock to accommodate for the extra second.</p>
<p>Though it's just a single second, this does have the ability cause <a href="https://www.wired.com/2012/07/leap-second-glitch-explained/">issues</a>. In python to track a leap second you can use <a href="https://docs.astropy.org/en/stable/time/index.html">astropy</a> which accounts for leap seconds</p>
<script type="py-editor" config='{"packages":["astropy"]}'>
from astropy.time import Time, TimeDelta
import astropy.units as u

# Define two dates that span a leap second
# A leap second was added on 2016-12-31 at 23:59:60 UTC
t1 = Time("2016-12-31T23:59:59", scale='utc')
t2 = Time("2017-01-01T00:00:01", scale='utc')

# Calculate the duration
print(f"{(t2 - t1).sec} seconds")
</script>

<p>Whilst it's unlikely that you'll need to regularly reach for this, it is good to know what to do when the issue of leap seconds becomes relevant.</p>
<h3>Datetime and timezones</h3>
<blockquote>
<p>NOTE: the pyodide editors may not load timezones properly, apologies in advance</p>
</blockquote>
<p>I get reminded (almost) every year on new quirks about it. For the most part the only reasonable thing to do is to use UTC whenever possible:</p>
<div class="highlight"><pre><span></span><code><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
</code></pre></div>

<p>if you use <code>datetime.now()</code> without timezones please don't, it's bad, you'll regret it sooner or later. <code>datetime.utcnow()</code> is really not much better and has in fact been deprecated.</p>
<p>Now just because you use timezone aware datetime doesn't mean you're safe. If you use a timezone with daylight saving time, when the times go back 1hr we get an overlapping interval (a folded datetime):</p>
<script type="py-editor" env="datetime" config='{"packages":["tzdata"]}' setup>
from datetime import UTC, datetime, timedelta
from zoneinfo import ZoneInfo
LONDON = ZoneInfo("Europe/London")
</script>

<script type="py-editor" env="datetime">
from datetime import UTC, datetime, timedelta
from zoneinfo import ZoneInfo

LONDON = ZoneInfo("Europe/London")
dt = datetime(2025, 10, 26, 1, tzinfo=UTC)
dt.astimezone(LONDON)
</script>
<p>This returns <code>datetime.datetime(2025, 10, 26, 1, 0, fold=1, tzinfo=zoneinfo.ZoneInfo(key='Europe/London'))</code></p>
<script type="py-editor" env="datetime">
datetime(2025, 10, 26, 0, tzinfo=UTC).astimezone(LONDON)
</script>
<p>Returns the non-folded <code>datetime.datetime(2025, 10, 26, 1, 0, tzinfo=zoneinfo.ZoneInfo(key='Europe/London'))</code></p>
<p>So far so good, but what if we compare them like this:</p>
<script type="py-editor" env="datetime">
(
    datetime(2025, 10, 26, 0, tzinfo=UTC).astimezone(LONDON) 
    == datetime(2025, 10, 26, 1, tzinfo=UTC).astimezone(LONDON)
)
</script>
<p>We get <code>True</code> which is not at all what I expected. This is because for same zone comparison only the wall clock time is used to preserve backwards compatibility, you can read more about it in <a href="https://peps.python.org/pep-0495/#backward-compatibility">PEP-495</a></p>
<p>But the weirdness doesn't end here: </p>
<script type="py-editor" env="datetime">
(dt := datetime(2025, 10, 26, 1, tzinfo=UTC)).astimezone(LONDON) == dt
</script>

<p>Normally the above script will return <code>True</code> for any datetime, DST or otherwise. But during folded time (whichever side of the fold you're on), this will <a href="https://peps.python.org/pep-0495/#aware-datetime-equality-comparison">always return False</a>. </p>
<p>The reason is is explained in the footnote:</p>
<blockquote>
<p>This exception is designed to preserve the hash and equivalence invariants in the face of paradoxes of inter-zone arithmetic</p>
</blockquote>
<p>If <code>datetime(2025, 10, 26, 1, tzinfo=UTC)).astimezone(LONDON)</code> were to equal <code>datetime(2025, 10, 26, 1, tzinfo=UTC)</code> then the hash must be equal. But due to backwards compatibility the hash is not equal there. So we don't allow the value to be equal either. </p>
<p>This is so baffling, it took me several tries to understand it.</p>
<h2>Finally</h2>
<p>Honestly I learned a lot more about time keeping than I expected when researching this topic. I believe no matter the language or tools, it will always be a difficult problem. And as such, we must treat it with the care it deserves when we're building a system that is sensitive to these timestamps.</p>                    </article>
                </aside><!-- /#featured -->
                    <section id="content" class="body">
                        <h1>Other articles</h1>
                        <hr />
                        <ol id="posts-list" class="hfeed">

                <li><article class="hentry">
                    <header>
                        <h1><a href="../asyncio-backpressure-processing-lots-of-tasks-in-parallel.html" rel="bookmark"
                               title="Permalink to Asyncio backpressure - Processing lots of tasks in parallel">Asyncio backpressure - Processing lots of tasks in parallel</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-06-20T00:00:00+01:00">
                Published: Fri 20 June 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>There's mixed feedback to Asyncio in the community. Some people passionately hate it whilst others believe "writing async make program go fast". This debate is way too much for me to cover here right now. Though maybe I'll look at it in the future. </p>
<p>For me I use asyncio a …</p>
                        <a class="readmore" href="../asyncio-backpressure-processing-lots-of-tasks-in-parallel.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../dockers-mcp-toolkit-first-look.html" rel="bookmark"
                               title="Permalink to Docker's MCP toolkit First Look">Docker's MCP toolkit First Look</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-06-12T00:00:00+01:00">
                Published: Thu 12 June 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>Short update since <a href="../first-look-at-mcp.html">First Look at MCP</a>. Docker has released it's <a href="https://docs.docker.com/ai/mcp-catalog-and-toolkit/toolkit/">MCP toolkit</a> which includes a catalog of MCP servers as well as helpers to connect to the MCP clients.</p>
<p>It is exceeding easy to use it, docker is registered as a single MCP server for your client. And tools …</p>
                        <a class="readmore" href="../dockers-mcp-toolkit-first-look.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../first-look-at-mcp.html" rel="bookmark"
                               title="Permalink to First Look at MCP">First Look at MCP</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-06-03T00:00:00+01:00">
                Published: Tue 03 June 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>Previously I've played with tool calling in <a href="../python-in-python-sandboxing-llm-generated-code.html">Langchain and Python sandboxes</a>. But recently MCP (Model Context Protocol) is front and center. So I tried to create my own github MCP in Python to integrate <a href="https://www.cursor.com/">cursor</a> with the github cli.</p>
<h1>What is MCP?</h1>
<p>Before we get started, its good to familiarise …</p>
                        <a class="readmore" href="../first-look-at-mcp.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../python-314-state-of-free-threading.html" rel="bookmark"
                               title="Permalink to Python 3.14: State of free threading">Python 3.14: State of free threading</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-05-26T00:00:00+01:00">
                Published: Mon 26 May 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>In my posts earlier this year I talked about the parallelism performance on 3.13 free-threaded builds. In particular I looked at solving an advent of code <a href="https://adventofcode.com/2024/day/6">problem</a>. In <a href="../how-free-are-threads-in-python-now.html">How free are threads in Python now?</a> I discovered significant performance penalties for using free-threading and a lack of tooling available …</p>
                        <a class="readmore" href="../python-314-state-of-free-threading.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../t-strings-the-good-and-the-ugly.html" rel="bookmark"
                               title="Permalink to t-strings: the good and the ugly">t-strings: the good and the ugly</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-05-07T00:00:00+01:00">
                Published: Wed 07 May 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>This one's hot off the press as the first beta for Python 3.14 (aka. π-thon) has hit. We're looking at a chunky release with a lot of new features. But  all I can think about are these new template strings (officially <code>t-strings</code>). </p>
<p><a href="https://peps.python.org/pep-0750/">PEP-750</a> officially introduces the concept. The idea …</p>
                        <a class="readmore" href="../t-strings-the-good-and-the-ugly.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../why-you-should-write-your-tools-in-python-again.html" rel="bookmark"
                               title="Permalink to Why you should write your tools in Python Again">Why you should write your tools in Python Again</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-04-08T00:00:00+01:00">
                Published: Tue 08 April 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>You're probably thinking that there are already plenty of tools written in Python.</p>
<p>But I see that most of the popular tools like <code>mypy</code> and <code>flake8</code> are built for development environments. In contrast, general purpose cli tools tend to be built in other languages, for example most of the docker …</p>
                        <a class="readmore" href="../why-you-should-write-your-tools-in-python-again.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../building-a-dsl-with-python-operators.html" rel="bookmark"
                               title="Permalink to Building a DSL with Python Operators">Building a DSL with Python Operators</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-03-12T00:00:00+00:00">
                Published: Wed 12 March 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I've been a little obsessed with operator overloading lately. First using <code>|=</code> in <a href="../sqlalchemy-footgun-discarding-the-statement.html">sqlalchemy-builder</a> and then using <code>|</code> and <code>@</code> in <a href="../better-functools-python-functional-fun.html">better-functools</a>. </p>
<p>I didn't actually know that these qualify as DSLs, specifically what's known as "internal DSLs". Funnily enough, I'm usually not a fan of DSLs. A few reasons come to mind:</p>
<ul>
<li>DSLs …</li></ul>
                        <a class="readmore" href="../building-a-dsl-with-python-operators.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../better-functools-python-functional-fun.html" rel="bookmark"
                               title="Permalink to better-functools: Python functional fun">better-functools: Python functional fun</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-03-09T00:00:00+00:00">
                Published: Sun 09 March 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I recently put some effort into creating <a href="https://github.com/Jamie-Chang/better-functools">better-functools</a>. It's a package that adds some tooling for functional programming in Python. And allows us to write some unique looking code in a manner similar to functional languages:</p>
<p><img alt="better-functools" src="../images/better-functools.png">
<a href="https://pydantic.run/store/a075fad4d27ad9d0">Try in sandbox</a></p>
<h3>Why?</h3>
<p>At a glance this doesn't look very "Pythonic". More complex …</p>
                        <a class="readmore" href="../better-functools-python-functional-fun.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../sqlalchemy-footgun-discarding-the-statement.html" rel="bookmark"
                               title="Permalink to Sqlalchemy Footgun: Discarding the statement">Sqlalchemy Footgun: Discarding the statement</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-02-02T00:00:00+00:00">
                Published: Sun 02 February 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>This one has frustrated me for a while. </p>
<p>It starts off with a REST API route. For example in fastAPI</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">search_users</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds users optionally filter by user_id&quot;&quot;&quot;</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>Then we get asked …</p>
                        <a class="readmore" href="../sqlalchemy-footgun-discarding-the-statement.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>
                    </ol><!-- /#posts-list -->
  <nav>
    <ul>
      <li>Page 1 / 2</li>
        <li><a href="../author/jamie-chang2.html">&rang;</a></li>
        <li><a href="../author/jamie-chang2.html">&Rang;</a></li>
    </ul>
  </nav>
                    </section><!-- /#content -->
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/jamie-chang.bsky.social/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>