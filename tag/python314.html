<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Jamie's Blog - Python3.14</title>
                        <link rel="stylesheet" href="../theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="../">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li><a href="../category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="../python-314-3-asyncio-changes.html">Python 3.14: 3 Asyncio Changes</a></h1>
<footer class="post-info">
        <abbr class="published" title="2025-10-09T00:00:00+01:00">
                Published: Thu 09 October 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">πthon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/asyncio.html">asyncio</a> </p>        
</footer><!-- /.post-info --><p>Python 3.14 was officially released on October 7th. There are a lot of new features and I've covered some of them before in:</p>
<ul>
<li><a href="../python-314-3-smaller-features.html">Python 3.14: 3 smaller features</a></li>
<li><a href="../t-strings-the-good-and-the-ugly.html">t-strings: the good and the ugly</a></li>
<li><a href="../subinterpreters-and-asyncio.html">Subinterpreters and Asyncio</a></li>
</ul>
<p>What I haven't covered here are any of the asyncio changes. There just happened to also be 3 changes to Asyncio this release ... </p>
<h3>Asyncio Debugger</h3>
<p>Python's builtin debugger <a href="https://docs.python.org/3/library/pdb.html"><code>pdb</code></a> may seem basic but one of its most powerful features is to run python code at a breakpoint:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">breakpoint</span><span class="p">()</span>  <span class="c1"># or import pdb; pdb.set_trace()</span>
    <span class="o">...</span>
</code></pre></div>

<p>Which enters the debugger at the stack frame where breakpoint is called and allows us to interact with objects in scope. </p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">my_func</span><span class="p">({})</span>
<span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">jamie</span><span class="o">.</span><span class="n">chang</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">Jamie</span><span class="o">-</span><span class="n">Blog</span><span class="o">/&lt;</span><span class="n">stdin</span><span class="o">&gt;-</span><span class="mi">0</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">my_func</span><span class="p">()</span>
<span class="o">-&gt;</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="p">(</span><span class="n">Pdb</span><span class="p">)</span><span class="w"> </span><span class="n">data</span>
<span class="p">{}</span>
<span class="p">(</span><span class="n">Pdb</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>

<p>However when it comes to asyncio commands it gets tricky:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyClient</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">MyClient</span><span class="p">()</span>
    <span class="nb">breakpoint</span><span class="p">()</span>
    <span class="o">...</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>(Pdb) client.now()
&lt;coroutine object MyClient.now at 0x102ad16c0&gt;
</code></pre></div>

<p>We cannot await at all in pdb:</p>
<div class="highlight"><pre><span></span><code>(Pdb) await client.now()
*** SyntaxError: &#39;await&#39; outside function
</code></pre></div>

<p>Nor can we run it with <code>asyncio.run</code>:</p>
<div class="highlight"><pre><span></span><code>(Pdb) asyncio.run(client.now())
*** RuntimeError: asyncio.run() cannot be called from a running event loop
</code></pre></div>

<p>Now this is possible with <a href="https://docs.python.org/3.14/library/pdb.html#pdb.set_trace_async">pdb.set_trace_async</a></p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">MyClient</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace_async</span><span class="p">()</span>
    <span class="o">...</span>
</code></pre></div>

<blockquote>
<p>Note that <code>set_trace_async()</code> is awaited here. As I understand it, this is a necessary compromise to get this feature working.</p>
</blockquote>
<p>And ... Success!</p>
<div class="highlight"><pre><span></span><code>(Pdb) print(await client.now())
1759933736.955492
</code></pre></div>

<p>This might be a niche feature, but it's crucial for debugging things like async ORMs.</p>
<p>If you just need to interact with async resources in a REPL, you can already start an async REPL since Python 3.8:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>asyncio
asyncio<span class="w"> </span>REPL<span class="w"> </span><span class="m">3</span>.9.6<span class="w"> </span><span class="o">(</span>default,<span class="w"> </span>Nov<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">2024</span>,<span class="w"> </span><span class="m">03</span>:15:38<span class="o">)</span><span class="w"> </span>
<span class="o">[</span>Clang<span class="w"> </span><span class="m">16</span>.0.0<span class="w"> </span><span class="o">(</span>clang-1600.0.26.6<span class="o">)]</span><span class="w"> </span>on<span class="w"> </span>darwin
Use<span class="w"> </span><span class="s2">&quot;await&quot;</span><span class="w"> </span>directly<span class="w"> </span>instead<span class="w"> </span>of<span class="w"> </span><span class="s2">&quot;asyncio.run()&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span>,<span class="w"> </span><span class="s2">&quot;copyright&quot;</span>,<span class="w"> </span><span class="s2">&quot;credits&quot;</span><span class="w"> </span>or<span class="w"> </span><span class="s2">&quot;license&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>asyncio
&gt;&gt;&gt;<span class="w"> </span>await<span class="w"> </span>asyncio.sleep<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</code></pre></div>

<h3>Asyncio Introspection</h3>
<p>Whether I'm teaching asyncio to newcomers or debugging complex concurrent programs myself. I've always found it difficult to visualise what's happening. </p>
<blockquote>
<p>When teaching asyncio we often just time the difference in performance, explaining it properly is hard.</p>
</blockquote>
<p>It is now possible with <a href="https://docs.python.org/3.14/whatsnew/3.14.html#asyncio-introspection-capabilities">introspection</a>. We can see the current call graph at runtime by:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>-m<span class="w"> </span>asyncio<span class="w"> </span>pstree<span class="w"> </span><span class="m">12345</span>
</code></pre></div>

<p>where 12345 is the process id.</p>
<blockquote>
<p>Note on macOS it needs to be run using sudo.</p>
</blockquote>
<p>The graph looks like:</p>
<div class="highlight"><pre><span></span><code>└── (T) Task-1
    └──  main /Users/jamie.chang/projects/concurreny-bench/backpressure/semaphore3.py:25
        └──  Semaphore.acquire /Users/jamie.chang/.local/share/uv/python/cpython-3.14.0rc3-macos-aarch64-none/lib/python3.14/asyncio/locks.py:407
            ├── (T) Task-30376
            │   └──  process_url /Users/jamie.chang/projects/concurreny-bench/backpressure/semaphore3.py:15
            │       └──  sleep /Users/jamie.chang/.local/share/uv/python/cpython-3.14.0rc3-macos-aarch64-none/lib/python3.14/asyncio/tasks.py:702
            ├── (T) Task-30389
            │   └──  process_url /Users/jamie.chang/projects/concurreny-bench/backpressure/semaphore3.py:15
            │       └──  sleep /Users/jamie.chang/.local/share/uv/python/cpython-3.14.0rc3-macos-aarch64-none/lib/python3.14/asyncio/tasks.py:702
            ├── (T) Task-30393
            │   └──  process_url /Users/jamie.chang/projects/concurreny-bench/backpressure/semaphore3.py:15
            │       └──  sleep /Users/jamie.chang/.local/share/uv/python/cpython-3.14.0rc3-macos-aarch64-none/lib/python3.14/asyncio/tasks.py:702
            ├── (T) Task-30408
            │   └──  process_url /Users/jamie.chang/projects/concurreny-bench/backpressure/semaphore3.py:15
            │       └──  sleep /Users/jamie.chang/.local/share/uv/python/cpython-3.14.0rc3-macos-aarch64-none/lib/python3.14/asyncio/tasks.py:702
</code></pre></div>

<p>And make it a lot clearer what's going on inside the event loop. </p>
<p>Since it can be triggered on a currently running process, we can even use this to debug a live running application that may be stuck on some async resources. </p>
<p>I've been using this with <a href="https://en.wikipedia.org/wiki/Watch_(command)">watch</a> to see a live view of the graph.</p>
<p>You can also get the information in table form by:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>-m<span class="w"> </span>asyncio<span class="w"> </span>ps<span class="w"> </span><span class="m">12345</span>
</code></pre></div>

<p>Finally, there are new <a href="https://docs.python.org/3.14/library/asyncio-graph.html">python apis</a> for this to get the information at a specific point in the code.</p>
<h3>Asyncio in multiple free threads</h3>
<p>Not to be confused with <a href="../free-threaded-python-with-asyncio.html">Free Threaded Python With Asyncio</a>. Where we run specific blocking code in threads using <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.to_thread">asyncio.to_thread</a>.</p>
<p>Prior to 3.14 event loops were not thread safe in the free-threaded builds of Python. This means you can't run asyncio in a separate thread. In Python 3.14 Kumar Aditya updated the event loop implementation maing it thread safe whilst also improving performance. You can see his blog post <a href="https://labs.quansight.org/blog/scaling-asyncio-on-free-threaded-python">here</a>.</p>
<p>But if we are already doing things concurrently why would threads matter? Well this actually depends on how much blocking work your coroutines are doing.</p>
<p>Let's say we have N coroutines all fetching data from a web page somewhere. This is perfect for asyncio, as http requests can be made without blocking the event loop.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">scrape</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</code></pre></div>

<p>But what do we do with the scraped data? We need to parse this, so this will block the event loop as it's CPU bound.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">scrape</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># CPU bound</span>
    <span class="o">...</span>

<span class="o">...</span>

<span class="k">async</span> <span class="k">with</span> <span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">process</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</code></pre></div>

<p>You will ind that the CPU bound tasks will impact the performance of the event loop. This is actually a situation that I've run into a couple times already. This can be solved with <code>asyncio.to_thread</code> here but sharing a lot of data right now may have a <a href="../how-free-are-threads-in-python-now.html">performance impact</a>. </p>
<p>Instead we can now spawn multiple free-threads with event loops. Each thread is still impacted by the CPU bound blocking tasks, however as we are processing the CPU-bound work concurrently, the impact is lowered. </p>
<p>We will need a way to pass data between the threads, the best way I found is using <a href="https://docs.python.org/3/library/queue.html#queue.Queue">queue.Queue</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">process</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">())</span>
</code></pre></div>

<p>For benchmark performances it's better to check Kumar's blog post. He posts a very impressive performance improvement, which I also see in my own examples. He also shows a much higher raw TCP performance so there's potential to increase IO bound workloads as well.</p>
<p>On the other hand, I found free-threading memory sharing awkward right now in Python and that impacts performance. My preferred method is using my very own <a href="https://github.com/Jamie-Chang/aiointerpreters/blob/main/examples/crawl.py">aiointerpreters</a> to launch the tasks to interpreter threads with subinterpreter's powerful shared memory functionality. </p>
<p>As with a lot of concurrency problems, there is not a single way to solve these. This is fine, and you should try different approaches, run benchmarks see how they compare to pick the best method for your problem. </p>                    </article>
                </aside><!-- /#featured -->
                    <section id="content" class="body">
                        <h1>Other articles</h1>
                        <hr />
                        <ol id="posts-list" class="hfeed">

                <li><article class="hentry">
                    <header>
                        <h1><a href="../subinterpreters-and-asyncio.html" rel="bookmark"
                               title="Permalink to Subinterpreters and Asyncio">Subinterpreters and Asyncio</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-08-05T00:00:00+01:00">
                Published: Tue 05 August 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">πthon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/subinterpreters.html">Subinterpreters</a> </p>        
</footer><!-- /.post-info -->                        <p><a href="https://peps.python.org/pep-0734">PEP-734</a> subinterpreters in the stdlib has officially been included in the Python 3.14 as a very late <a href="https://docs.python.org/3.14/whatsnew/3.14.html#whatsnew314-pep734">addition</a>. subinterpreters now has a new home in the standard library module called <a href="https://docs.python.org/3.14/library/concurrent.interpreters.html">concurrent.interpreters</a>.</p>
<p>If you've been following my blog posts you'll know that I'm particularly excited about this feature. </p>
<ul>
<li><a href="../how-good-are-sub-interpreters-in-python-now.html">How …</a></li></ul>
                        <a class="readmore" href="../subinterpreters-and-asyncio.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../python-314-3-smaller-features.html" rel="bookmark"
                               title="Permalink to Python 3.14: 3 smaller features">Python 3.14: 3 smaller features</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-07-11T00:00:00+01:00">
                Published: Fri 11 July 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">πthon</a> <a href="../tag/python314.html">Python3.14</a> </p>        
</footer><!-- /.post-info -->                        <p>Python 3.14 is just around the corner and it's jampacked with huge updates:</p>
<ul>
<li><a href="../python-314-state-of-free-threading.html">Free threading and multiple interpreters?</a></li>
<li><a href="../t-strings-the-good-and-the-ugly.html">Template strings</a></li>
</ul>
<p>But as with any release, there are many nice smaller and less noticeable features. Features you won't see unless you comb through the entire <a href="https://docs.python.org/3.14/whatsnew/3.14.html">release notes</a>. Luckily I am …</p>
                        <a class="readmore" href="../python-314-3-smaller-features.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../python-314-state-of-free-threading.html" rel="bookmark"
                               title="Permalink to Python 3.14: State of free threading">Python 3.14: State of free threading</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-05-26T00:00:00+01:00">
                Published: Mon 26 May 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">πthon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/free-threading.html">Free-threading</a> <a href="../tag/subinterpreters.html">Subinterpreters</a> </p>        
</footer><!-- /.post-info -->                        <p>In my posts earlier this year I talked about the parallelism performance on 3.13 free-threaded builds. In particular I looked at solving an advent of code <a href="https://adventofcode.com/2024/day/6">problem</a>. In <a href="../how-free-are-threads-in-python-now.html">How free are threads in Python now?</a> I discovered significant performance penalties for using free-threading and a lack of tooling available …</p>
                        <a class="readmore" href="../python-314-state-of-free-threading.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="../t-strings-the-good-and-the-ugly.html" rel="bookmark"
                               title="Permalink to t-strings: the good and the ugly">t-strings: the good and the ugly</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-05-07T00:00:00+01:00">
                Published: Wed 07 May 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="../author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="../category/blog.html">Blog</a>.</p>
<p>tags: <a href="../tag/python.html">Python</a> <a href="../tag/pthon.html">πthon</a> <a href="../tag/python314.html">Python3.14</a> <a href="../tag/t-strings.html">t-strings</a> </p>        
</footer><!-- /.post-info -->                        <p>This one's hot off the press as the first beta for Python 3.14 (aka. π-thon) has hit. We're looking at a chunky release with a lot of new features. But  all I can think about are these new template strings (officially <code>t-strings</code>). </p>
<p><a href="https://peps.python.org/pep-0750/">PEP-750</a> officially introduces the concept. The idea …</p>
                        <a class="readmore" href="../t-strings-the-good-and-the-ugly.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>
                    </ol><!-- /#posts-list -->
                    </section><!-- /#content -->
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/changs.co.uk/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>