<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Customising Pattern Matching Behaviour</title>
                        <link rel="stylesheet" href="./theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
    <meta name="description" content="I've been doing advent of code again this year. There are two Python features I always rely on, iterators and pattern matching. Iterators allow..." />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="./">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li class="active"><a href="./category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./customising-pattern-matching-behaviour.html" rel="bookmark"
             title="Permalink to Customising Pattern Matching Behaviour">Customising Pattern Matching Behaviour</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-12-09T00:00:00+00:00">
                Published: Mon 09 December 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->        <p>I've been doing <a href="https://adventofcode.com/">advent of code</a> again this year. There are two Python features I always rely on, iterators and pattern matching. Iterators allow for operations on each of its elements without allocating memory for a collection. Ever since pattern matching was introduced in Python 3.10, it's been particularly useful to unpack nested object structure. </p>
<p>Unfortunately pattern matching and iterators don't work well together. By definition elements of an iterator do not necessarily exist so there's nothing to match against. Often to pattern match we must first consume the iterator:</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span> 
    <span class="k">case</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="k">_</span><span class="p">]:</span>  <span class="c1"># Won&#39;t match of course</span>
        <span class="o">...</span>

<span class="k">match</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span>
    <span class="k">case</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="k">_</span><span class="p">]:</span>  <span class="c1"># matches now since iterator is consumed</span>
        <span class="o">...</span>
</code></pre></div>

<p>Ideally we'd be able to consume the head elements of the iterator on demand, but this isn't possible directly with iterators.</p>
<h3>Official Support for Custom Matching</h3>
<p>In the original PEP, there's mention of the idea of <a href="https://peps.python.org/pep-0622/#custom-matching-protocol">custom matchers</a>. But the idea was ultimately deferred due to the lack of a clear use case. </p>
<h3>Matching Properties</h3>
<p>But it turns out we don't really need any of this. We can match any named attributes of an object even a <code>property</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Repeat</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">times</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span>


<span class="k">match</span> <span class="n">Repeat</span><span class="p">(</span><span class="s2">&quot;abcd&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">Repeat</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span> <span class="k">as</span> <span class="n">repeated</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After </span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2"> times&quot;</span><span class="p">,</span> <span class="n">repeated</span><span class="p">)</span>
</code></pre></div>

<p>This is really useful as we need to dynamically unpack the iterator if we want to match the iterator. We can create an object with the <code>next</code> property that evaluates the next elements on demand.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_iter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">it</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>


<span class="k">match</span> <span class="n">Node</span><span class="o">.</span><span class="n">from_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))):</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 0 and 1&quot;</span><span class="p">)</span>
</code></pre></div>

<p>There is a bug in the code, consider the following match statement:</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span> <span class="n">Node</span><span class="o">.</span><span class="n">from_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))):</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 9 and 8&quot;</span><span class="p">)</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 0 and 1&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The looks like it'll match in the second <code>case</code>, but it can't. This is because the first <code>case</code> checks the first 2 elements by consuming them. </p>
<p>But the fix is actually really simple, we simple use <code>cached_property</code> to cache the result of <code>next</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_iter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">it</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
</code></pre></div>

<h3>Matching positionally using <code>__match_args__</code></h3>
<p>Matching named attributes can be very verbose. We can specify which arguments to match sequentially by adding  <a href="https://peps.python.org/pep-0622/#special-attribute-match-args"><code>__match_args__</code></a> to the class:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="n">__match_args__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_iter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">it</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>


<span class="k">match</span> <span class="n">Node</span><span class="o">.</span><span class="n">from_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))):</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 9 and 8&quot;</span><span class="p">)</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 0 and 1&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>Matching the end of iteration</h3>
<p>Finally we need to consider the <code>StopIteration</code> at the end of the iterator.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="n">__match_args__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_iter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">it</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<span class="k">match</span> <span class="n">Node</span><span class="o">.</span><span class="n">from_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="k">_</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 9 and 8&quot;</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starts with 0&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>Conclusion</h3>
<p>You might still be wondering if this is actually useful. I've published this as <a href="https://github.com/Jamie-Chang/pattern-utils">pattern-utils</a> so you can try it out. Beware the implementation is slightly different to facilitate matching generator with return, for example,</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pattern_utils</span> <span class="kn">import</span> <span class="n">generator</span> <span class="k">as</span> <span class="n">gen</span>


<span class="k">def</span> <span class="nf">example_generator</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s2">&quot;some resource&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>


<span class="k">match</span> <span class="n">gen</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">example_generator</span><span class="p">()):</span>
    <span class="k">case</span> <span class="n">gen</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">gen</span><span class="o">.</span><span class="n">Empty</span><span class="p">(</span><span class="n">end_result</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">end_result</span><span class="p">)</span>
</code></pre></div>

<p>I think more important is using the same technique of writing a wrapper with properties to better exploit pattern matching. If I discover other common use cases I will update the library.</p>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/jamie-chang.bsky.social/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>