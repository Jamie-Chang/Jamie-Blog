<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Jamie's Blog</title>
                        <link rel="stylesheet" href="./theme/css/main.css" />
                                <link href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jamie's Blog Atom Feed" />
                        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0358c4be608641c1ad90cd87801da29b"}'></script><!-- End Cloudflare Web Analytics -->
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="./">Jamie's Blog</a></h1>
                        <nav><ul>
                                                <li><a href="./category/blog.html">Blog</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="./putting-the-fun-back-in-functional-programming.html">Putting the fun back in functional programming</a></h1>
<footer class="post-info">
        <abbr class="published" title="2025-03-09T00:00:00+00:00">
                Published: Sun 09 March 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info --><p>I recently put some effort into creating <a href="https://github.com/Jamie-Chang/better-functools">better-functools</a>. It's a package that adds some tooling for functional programming in Python. And allows us to write some unique looking code in a manner similar to functional languages:</p>
<p><img alt="better-functools" src="./images/better-functools.png">
<a href="https://pydantic.run/store/a075fad4d27ad9d0">Try in sandbox</a></p>
<h3>Why?</h3>
<p>At a glance this doesn't look very "Pythonic". More complex expressions and syntax are often controversial in Python, but I don't think it's a good enough reason to avoid it. Python is a multi-paradigm language, but it can be awkward to do anything but the expected OOP. New syntax can really help with expanding what's possible with Python. A good example of new syntax is pattern matching, which is a feature that came from functional languages. I'm keen on using this to make functional programming more available to a wider user base, as opposed to the stereotypical functional bros.</p>
<h3>Inspiration</h3>
<p>If you can't tell already, this is largely inspired by ML specifically <a href="https://ocaml.org/">OCaml</a>. Last Christmas I decided to solve <a href="https://github.com/Jamie-Chang/advent2024/tree/main">Advent of Code</a> in OCaml and I loved it.</p>
<p>The biggest takeaway from this experience is that you don't need to understand monads or the other mathematical concepts to program functionally. Those are probably things you come around later but it's not make functional programming fun.</p>
<p>What I loved most is the the system and ergonomics in OCaml. </p>
<blockquote>
<p>Note: The ML family are not the only programming languages, other languages may have a stronger focus on ergonomics than type safety.</p>
</blockquote>
<p>OCaml is strongly typed but does not require explicit annotations, instead types are inferred.
For example, the signature of add in the following snippet is automatically inferred as <code>+</code> operator only takes integer values.</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">add</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="c">(* val add : int -&gt; int -&gt; int = &lt; fun &gt; *)</span>
</code></pre></div>

<p>This greatly reduces the burden on programmers. </p>
<p>On the topic of ergonomics, OCaml like many other functional languages has a lot of features to make composing functions and chaining function calls easier. The most notable of which are currying:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">add</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">let</span> <span class="n">inc</span> <span class="o">=</span> <span class="n">add</span> <span class="mi">1</span>
</code></pre></div>

<p>And <a href="https://cs3110.github.io/textbook/chapters/hop/pipelining.html">pipeline</a>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="mi">1</span><span class="o">;</span> <span class="mi">2</span><span class="o">;</span> <span class="mi">3</span><span class="o">;</span> <span class="mi">4</span><span class="o">]</span> <span class="o">|&gt;</span> <span class="n">map</span> <span class="n">inc</span> <span class="o">|&gt;</span> <span class="n">sum</span> <span class="o">|&gt;</span> <span class="n">string_of_int</span> <span class="o">|&gt;</span> <span class="n">print_endline</span>
</code></pre></div>

<p>The implication of this is that you rarely need to abstract out functions because you can easily compose and chain them inline when you need them.</p>
<h3>Functional patterns with <code>better-functools</code> and Python</h3>
<p>So how can we use these ideas in Python?</p>
<h4>Currying</h4>
<p>We can also do currying in Python, but it's awkward as Python has many different types of arguments: defaulted, positional, keyword and combinations of all of them.</p>
<p>Instead I've added <code>@bind(...)</code> as a short hand to bind an argument and always return a partial.</p>
<div class="highlight"><pre><span></span><code><span class="n">inc</span> <span class="o">=</span> <span class="n">add</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>The resulting expression is a bit more verbose than currying but has the same look and feel.</p>
<h4>pipeline</h4>
<p>The <a href="https://cs3110.github.io/textbook/chapters/hop/pipelining.html">'pipeline'</a> operator <code>|&gt;</code> in OCaml chains operations together in a clear and concise way. And I'm definitely not the only person to think this way:</p>
<ul>
<li><a href="https://github.com/tc39/proposal-pipeline-operator">TC39</a> is a proposal to add <code>|&gt;</code> in JS.</li>
<li>There are other python libraries that implement similar ideas e.g. <a href="https://pypi.org/project/pipe/">pipe</a>.</li>
<li>In golang a <a href="https://github.com/golang/go/issues/68534">rejected proposal</a></li>
</ul>
<p>My approach uses the <code>|</code> operator in python and you must explicitly start and end a pipeline</p>
<div class="highlight"><pre><span></span><code><span class="n">Pipeline</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">|</span> <span class="o">...</span> <span class="o">|</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">unwrap</span>
</code></pre></div>

<blockquote>
<p>The specific reason why I chose to make the <code>Pipeline</code> explicit but not <code>@</code> operations is mainly due to how common <code>|</code> is vs <code>@</code> in Python. Something I'll go in more depth in a future post. </p>
</blockquote>
<h4>Other Cool Patterns</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Binding partially to the second argument not the first</span>
<span class="n">func</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span> <span class="o">@</span> <span class="n">func</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Null coalescing </span>
<span class="n">nvl</span><span class="p">(</span><span class="n">count_or_none</span> <span class="o">@</span> <span class="n">nvl</span> <span class="o">@</span> <span class="n">apply</span><span class="p">(</span><span class="n">add</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># increment count or return null</span>

<span class="c1"># Composing functions inline</span>
<span class="nb">sum</span> <span class="o">@</span> <span class="n">compose</span><span class="p">(</span><span class="n">eq</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="mi">2020</span><span class="p">))</span>  <span class="c1"># check sum equal to 2020 </span>

<span class="c1"># Mixing `|` and `@`</span>
<span class="n">inputs</span>
<span class="o">|</span> <span class="nb">map</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="n">mul</span> <span class="o">@</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># multiply all inputs by 2</span>
<span class="o">|</span> <span class="nb">sum</span>  <span class="c1"># add them up</span>
<span class="o">|</span> <span class="n">eq</span> <span class="o">@</span> <span class="n">bind</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span>  <span class="c1"># check if they sum to 2020</span>
</code></pre></div>

<h3>Further Reading</h3>
<p>Overall it wasn't easy but I did learn a lot about Python's operators and type system. Don't worry if you'd like to know more about these topics, I'll have follow up more posts.</p>
<p>Here are some further reading material about functional programming:</p>
<ul>
<li>Official Python documentation on functional programming in Python <a href="https://docs.python.org/3/howto/functional.html">here</a></li>
<li><a href="https://ocaml.org/docs/tour-of-ocaml">A tour of OCaml</a> to get started with OCaml</li>
<li><a href="https://www.youtube.com/watch?v=nuML9SmdbJ4">Dear Functional Bros</a> an excellent video on functional programming and its relationship with OOP.</li>
</ul>                    </article>
                </aside><!-- /#featured -->
                    <section id="content" class="body">
                        <h1>Other articles</h1>
                        <hr />
                        <ol id="posts-list" class="hfeed">

                <li><article class="hentry">
                    <header>
                        <h1><a href="./sqlalchemy-footgun-discarding-the-statement.html" rel="bookmark"
                               title="Permalink to Sqlalchemy Footgun: Discarding the statement">Sqlalchemy Footgun: Discarding the statement</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-02-02T00:00:00+00:00">
                Published: Sun 02 February 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>This one has frustrated me for a while. </p>
<p>It starts off with a REST API route. For example in fastAPI</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">search_users</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds users optionally filter by user_id&quot;&quot;&quot;</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>Then we get asked …</p>
                        <a class="readmore" href="./sqlalchemy-footgun-discarding-the-statement.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./jamies-pattern-matching-cookbook.html" rel="bookmark"
                               title="Permalink to Jamie's Pattern Matching Cookbook">Jamie's Pattern Matching Cookbook</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-01-16T00:00:00+00:00">
                Published: Thu 16 January 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>Structural pattern matching is probably the coolest new syntax introduced to Python. Added in 3.10, it's been a few years now and more people are writing apps in 3.10<a href="https://lp.jetbrains.com/python-developers-survey-2023/#python-versions">*</a> than any other version now.</p>
<p>Though even with the wide adoption of 3.10 and more people being exposed …</p>
                        <a class="readmore" href="./jamies-pattern-matching-cookbook.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./how-good-are-sub-interpreters-in-python-now.html" rel="bookmark"
                               title="Permalink to How good are sub-interpreters in Python now?">How good are sub-interpreters in Python now?</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-01-03T00:00:00+00:00">
                Published: Fri 03 January 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <h2>Introduction</h2>
<p>I wrote about free-threading recently in <a href="./how-free-are-threads-in-python-now.html">How free are threads in Python now?</a>. Where I found some unexpected difficulties parallelising my solution.</p>
<p>In the conclusion section I wrote:</p>
<blockquote>
<p>I'm starting to think that the approach <a href="https://peps.python.org/pep-0554/">sub-interpreters</a> is taking, with brand new concurrency primitives and shared memory data structures has …</p></blockquote>
                        <a class="readmore" href="./how-good-are-sub-interpreters-in-python-now.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./how-free-are-threads-in-python-now.html" rel="bookmark"
                               title="Permalink to How free are threads in Python now?">How free are threads in Python now?</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-12-31T00:00:00+00:00">
                Published: Tue 31 December 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>Free-threaded Python (<a href="https://peps.python.org/pep-0703/">PEP-703</a>) was released in October 2024. 
It enables true multi-threaded execution without the restriction of the <a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">GIL</a>.</p>
<p>I previously covered this in <a href="./free-threaded-python-with-asyncio.html">Free Threaded Python With Asyncio</a>, the example used there was selected because it very clearly demonstrates the performance increase, or moreover, the threads "running free".</p>
<p>But …</p>
                        <a class="readmore" href="./how-free-are-threads-in-python-now.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./customising-pattern-matching-behaviour.html" rel="bookmark"
                               title="Permalink to Customising Pattern Matching Behaviour">Customising Pattern Matching Behaviour</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-12-09T00:00:00+00:00">
                Published: Mon 09 December 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I've been doing <a href="https://adventofcode.com/">advent of code</a> again this year. There are two Python features I always rely on, iterators and pattern matching. Iterators allow for operations on each of its elements without allocating memory for a collection. Ever since pattern matching was introduced in Python 3.10, it's been particularly …</p>
                        <a class="readmore" href="./customising-pattern-matching-behaviour.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./python-in-python-sandboxing-llm-generated-code.html" rel="bookmark"
                               title="Permalink to Python-in-Python Sandboxing LLM Generated Code">Python-in-Python Sandboxing LLM Generated Code</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-12-02T00:00:00+00:00">
                Published: Mon 02 December 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I've been experimenting with <a href="https://www.langchain.com/">Langchain</a> for GPT based queries. One problem we often encounter with GPT is hallucinations. This makes certain classes of problems unsuited to GPT, one example is maths and statistics. Whilst there are improvements for recent models often the maths cannot be trusted.</p>
<p>When I try to …</p>
                        <a class="readmore" href="./python-in-python-sandboxing-llm-generated-code.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./my-sqlalchemy-cookbook.html" rel="bookmark"
                               title="Permalink to My SQLAlchemy Cookbook">My SQLAlchemy Cookbook</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-11-25T00:00:00+00:00">
                Published: Mon 25 November 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I've worked with SQLAlchemy for a while now, and in my opinion it's the best ORM in Python. It's feature rich with strong support for all major databases. And it maintains the SQL feel without losing things like typing.</p>
<p>However there are some challenges here. Despite having very nice documentation …</p>
                        <a class="readmore" href="./my-sqlalchemy-cookbook.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./typeddicts-are-better-than-you-think.html" rel="bookmark"
                               title="Permalink to TypedDicts are better than you think">TypedDicts are better than you think</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-10-01T00:00:00+01:00">
                Published: Tue 01 October 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p><code>TypedDict</code> was introduced in <a href="https://peps.python.org/pep-0589/">PEP-589</a> which landed in Python 3.8.</p>
<p>The primary use case was to create type annotations for dictionaries. For example,</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>


<span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Avatar&quot;</span><span class="p">}</span>
</code></pre></div>

<p>I remember thinking at the time that this was pretty neat, but I tend to use <code>dataclass …</code></p>
                        <a class="readmore" href="./typeddicts-are-better-than-you-think.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>

                <li><article class="hentry">
                    <header>
                        <h1><a href="./closing-python-iterators.html" rel="bookmark"
                               title="Permalink to Closing Python Iterators">Closing Python Iterators</a></h1>
                    </header>

                    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-09-28T00:00:00+01:00">
                Published: Sat 28 September 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/jamie-chang.html">Jamie Chang</a>
                </address>
        <p>In <a href="./category/blog.html">Blog</a>.</p>
        
</footer><!-- /.post-info -->                        <p>I recently came across a <a href="https://youtu.be/N56Jrqc7SBk?si=6WmYrq8C4E-gwn4_">video</a> by mcoding about Python iterators' unfortunate closing behaviour.</p>
<p>To sum up the video, when an iterator is interrupted we intuitively we would expect the exit of a context manager or a finally block to be called but that's not <strong>necessarily</strong> the case. For example …</p>
                        <a class="readmore" href="./closing-python-iterators.html">read more</a>
                    </div><!-- /.entry-content -->
                </article></li>
                    </ol><!-- /#posts-list -->
  <nav>
    <ul>
      <li>Page 1 / 2</li>
        <li><a href="./index2.html">&rang;</a></li>
        <li><a href="./index2.html">&Rang;</a></li>
    </ul>
  </nav>
                    </section><!-- /#content -->
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="https://blog.changs.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                                        <li><a href="https://github.com/Jamie-Chang/">Github</a></li>
                                                        <li><a href="https://www.linkedin.com/in/jamie-chang-4423ba125/">LinkedIn</a></li>
                                                        <li><a href="https://bsky.app/profile/jamie-chang.bsky.social/">Bluesky</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>